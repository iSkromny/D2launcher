<!DOCTYPE html>
<html>
<head>
    <title>D2Launcher Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .chart-container { margin: 30px 0; height: 400px; background: #f8f9fa; border-radius: 8px; padding: 15px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .comparison-section { margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        select, button { padding: 8px 15px; font-size: 16px; margin: 0 10px 10px 0; }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>D2Launcher Release Statistics</h1>
    <div id="stats-container">
        <p>Loading statistics...</p>
    </div>

    <div class="stats-grid">
        <div>
            <h2>Downloads per Release</h2>
            <div class="chart-container">
                <canvas id="releasesChart"></canvas>
            </div>
        </div>
        <div>
            <h2>Daily Downloads</h2>
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <div class="comparison-section">
        <h2>Version Comparison</h2>
        <div>
            <select id="version1"></select>
            <select id="version2"></select>
            <button onclick="compareVersions()">Compare</button>
            <div id="comparison-result" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Глобальные переменные для данных
        let statsData = null;
        let releasesChart = null;
        let dailyChart = null;

        fetch('https://raw.githubusercontent.com/iSkromny/D2launcher/main/stats.json')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                statsData = data;
                renderStats(data);
                renderCharts(data);
                populateVersionSelects(data);
            })
            .catch(error => {
                document.getElementById('stats-container').innerHTML = `
                    <h2>Error Loading Stats</h2>
                    <p>${error.message}</p>`;
                console.error('Fetch error:', error);
            });

        function renderStats(data) {
            document.getElementById('stats-container').innerHTML = `
                <div class="summary-cards">
                    <div class="card">
                        <h3>Total Releases</h3>
                        <p>${data.total_releases}</p>
                    </div>
                    <div class="card">
                        <h3>Total Downloads</h3>
                        <p>${data.total_downloads}</p>
                    </div>
                    <div class="card">
                        <h3>Last Updated</h3>
                        <p>${new Date(data.updated_at).toLocaleString()}</p>
                    </div>
                </div>`;
        }

        function renderCharts(data) {
            // График по релизам
            const releasesCtx = document.getElementById('releasesChart').getContext('2d');
            releasesChart = new Chart(releasesCtx, {
                type: 'bar',
                data: {
                    labels: data.releases.map(r => r.tag_name),
                    datasets: [{
                        label: 'Downloads',
                        data: data.releases.map(r => r.downloads),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Downloads'
                            }
                        }
                    }
                }
            });

            // График ежедневных скачиваний
            if (data.daily_downloads && data.daily_downloads.length > 0) {
                const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                dailyChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: data.daily_downloads.map(d => d.date),
                        datasets: [{
                            label: 'Daily Downloads',
                            data: data.daily_downloads.map(d => d.downloads),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Downloads'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        }
                    }
                });
            }
        }

        function populateVersionSelects(data) {
            const select1 = document.getElementById('version1');
            const select2 = document.getElementById('version2');
            
            data.releases.forEach(release => {
                const option = document.createElement('option');
                option.value = release.tag_name;
                option.textContent = release.tag_name;
                select1.appendChild(option.cloneNode(true));
                select2.appendChild(option);
            });
            
            // Автовыбор последних двух версий
            if (data.releases.length >= 2) {
                select1.selectedIndex = data.releases.length - 2;
                select2.selectedIndex = data.releases.length - 1;
            }
        }

        function compareVersions() {
            if (!statsData) return;
            
            const v1 = document.getElementById('version1').value;
            const v2 = document.getElementById('version2').value;
            
            const release1 = statsData.releases.find(r => r.tag_name === v1);
            const release2 = statsData.releases.find(r => r.tag_name === v2);
            
            if (!release1 || !release2) {
                document.getElementById('comparison-result').innerHTML = '<p>One or both versions not found</p>';
                return;
            }
            
            const ratio = release1.downloads > 0 
                ? (release2.downloads / release1.downloads).toFixed(2) 
                : 'N/A';
            
            const improvement = release1.downloads > 0
                ? `${((release2.downloads - release1.downloads) / release1.downloads * 100).toFixed(1)}%`
                : 'N/A';
            
            document.getElementById('comparison-result').innerHTML = `
                <div class="comparison-result">
                    <h3>Comparison Result: ${v1} vs ${v2}</h3>
                    <div class="versions-grid">
                        <div>
                            <h4>${v1}</h4>
                            <p><strong>Downloads:</strong> ${release1.downloads}</p>
                            <p><strong>Release Date:</strong> ${new Date(release1.created_at).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <h4>${v2}</h4>
                            <p><strong>Downloads:</strong> ${release2.downloads}</p>
                            <p><strong>Release Date:</strong> ${new Date(release2.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="metrics">
                        <p><strong>Popularity Ratio (${v2}/${v1}):</strong> ${ratio}</p>
                        <p><strong>Improvement:</strong> ${improvement}</p>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
